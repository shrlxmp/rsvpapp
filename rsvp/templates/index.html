{% extends "base.html" %}

{% block scripts %}
    <script>
     cancel_event = function(event_id){
         $(".alert").text('Cancelling event ...').show();
         fetch(`/api/event/${event_id}`,
               {method: "PATCH",
                credentials: 'same-origin',
                body: JSON.stringify({cancelled: true}),
                headers: {'content-type': 'application/json'}}).then(function(response){
                    if (response.status == 200){
                        window.location.href = "";
                    }
                    return response.json();
                }).then(function(data){
                    $(".alert").text(data.error).show();
                });
     }

    </script>
{% endblock %}

{% block content %}
    <section class="upcoming-events">
        <p class="d-inline h4">Upcoming Events
            <span class="badge badge-primary badge-pill">{{upcoming_events|length}}</span>
        </p>
        <a href="{{ url_for("event_editor") }}" align="center" class="d-inline btn btn-primary my-4">Add</a>
        <ul class="list-group">
            {% for item in upcoming_events %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {% if item.cancelled %}
                        <del>
                    {% endif %}
                    <span>
                        <span><a href="/event/{{item.id}}">{{ item.name }}</a></span>
                        {% if item.rsvps %}
                            <span class="badge badge-primary badge-pill">{{item.rsvp_count}}</span>
                        {% endif %}
                        {% if (item.created_by.id == current_user.email or current_user.is_admin) and not item.cancelled %}
                            <button class="btn btn-danger btn-sm" onclick='cancel_event("{{item.id}}")'>
                                <small>cancel</small>
                            </button>
                        {% endif %}
                    </span>
                    <span>{{ item.date | format_date }}</span>
                    {% if item.cancelled %}
                        </del>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    </section>

    <section class="recent-posts">
        {% if posts %}
            <p class="d-inline h4">Latest Post</p>
            <a class="text-muted" href="{{ url_for('show_posts') }}">See all</a>
            {% include 'post-list.html' %}
        {% endif %}
    </section>

    {% if photo_id %}
        <section class="random-photo">
            <div class="embed-responsive embed-responsive-{{photo_aspect_ratio}}">
                <iframe src="https://drive.google.com/file/d/{{photo_id}}/preview"></iframe>
            </div>
            {% if photo_location %}
                <a href="http://maps.google.com/?q={{ photo_location.latitude }},{{ photo_location.longitude }}" target="_blank">
                    <i class="fa fa-map-marker-alt"></i>
                </a>
            {% endif %}
            {% if photo_time %}
                ({{ photo_time.strftime("%d %b %Y, %H:%M") }})
            {% endif %}
            <a href="https://drive.google.com/drive/folders/{{photo_drive}}" target="_blank">
                See more
            </a>
        </section>
    {% endif %}

{% endblock %}
