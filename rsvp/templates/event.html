{% extends "base.html" %}

{% block scripts %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.2/awesomplete.min.css" integrity="sha256-TQcHzEz3/ZJ8MeAoO1SRE5sa5q68U57dwZO/tArtNqk=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.2/awesomplete.min.js" integrity="sha256-xA+USAVmEnBnz1FiLRSG8xglJflQVHmQvbx5+u4bslk=" crossorigin="anonymous"></script>
    <script>
     delete_rsvp = function(event_id, rsvp_id){
         $(".alert").text('Un-RSVPing...').show();
         fetch(`/api/rsvps/${event_id}/${rsvp_id}`,
               {credentials: 'same-origin', method: "DELETE"}).then(function(response){
                   if (response.status == 200){
                       window.location.href = "";
                   }
                   return response.json();
               }).then(function(data){
                   $(".alert").text(data.error).show();
               });
     }

     update_message = function(){
         if ($('#name').val() !== "") {
             $(".alert").text('RSVPing...').show();
         }
     }

     update_description = function(event_id){
         var data = {
             description: editor.codemirror.getValue()
         }
         fetch(`/api/event/${event_id}`,
               {credentials: 'same-origin', method: "PATCH", body: JSON.stringify(data)}).then(function(response){
                   if (response.status == 200){
                       window.location.href = "";
                   }
                   return response.json();
               }).then(function(data){
                   $(".alert").text(data.error).show();
               });
     }

    </script>
    <!-- Awesomeplete -->
    <script>
     var input = document.getElementById("email");
     new Awesomplete(input, {
         list: [
             {% for nick, name, email in approved_users.values_list('nick', 'name', 'email') %}
             { label: "{{nick or name}}", value: "{{email}}" },
             {% endfor %}
         ],
         minChars: 0
     });
    </script>
    <!-- Markdown editor -->
    <link rel="stylesheet" href="//cdn.jsdelivr.net/editor/0.1.0/editor.css">
    <script src="//cdn.jsdelivr.net/editor/0.1.0/editor.js"></script>
    <script src="//cdn.jsdelivr.net/editor/0.1.0/marked.js"></script>

    <script>
     var editor = new Editor({
         element: document.getElementById("event-description"),
         placeholder: "Please add a plan for the session!",
     });
    </script>
{% endblock %}

{% block content %}
    <p class="h2">
        {% if event.cancelled %}
            <del>{{ TEXT2 }}</del>
            <span class="badge badge-danger">Cancelled</span>
        {% else %}
            {{ TEXT2 }}
            {% if event.archived %}
                <span class="badge badge-secondary">Archived</span>
            {% endif %}
        {% endif %}
    </p>
    {% if current_user.is_admin or (not event.archived and not event.cancelled) %}
        <div class="card">
            <div class="card-body">
                <p class="alert alert-info" style="display: none;"></p>
                <form class="form-inline" action="/new/{{event.id}}" method='POST'>
                    <div class="form-group required mx-2">
                        <input  type="text"
                                name="email"
                                class="form-control"
                                id="email"
                                value="{{current_user.email}}"
                                required autofocus>
                    </div>
                    <button type="Submit" onclick="update_message()" align="center" name="submit" class="btn btn-primary mr-2">Submit</button>
                    <input type="text" name="note" class="form-control" id="note" placeholder="Additional note (optional)">
                </form>
            </div>
        </div>
    {% endif %}
    <hr/>
    {{ (event.html_description or '') | safe }}
    <hr/>
    <ul class="list-group">
        {% for item in items %}
            <li class="list-group-item {% if item.user.fetch().gender == 'female' and not item.cancelled -%}text-white bg-dark{% endif -%}">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="rsvp {% if item.cancelled %}rsvp-cancelled{% endif %}"
                          "data-toggle="tooltip" title="RSVP by {{item | rsvp_by}}">
                        {{item | rsvp_name}}
                    </span>
                    {% if current_user.is_admin or (not event.cancelled and not event.archived and (
                        current_user == item.rsvp_by
                        or current_user == item.user
                        or item.rsvp_by is none)
                    )  %}
                        <button onclick='delete_rsvp("{{event.id}}","{{item.id}}")' class="close {% if item.user.fetch().gender == 'female' and not item.cancelled -%}text-white{% endif -%}">x</button>
                    {% endif %}
                </div>
                {% if item.note %}
                    <div class="small text-muted">
                        {{ item.note }}
                    </div>
                {% endif %}
            </li>
        {% endfor %}
        {% if count %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <button class="btn btn-outline-info btn-sm my-2 copy-button"
                        data-placement="bottom"
                        data-clipboard-action="copy"
                        data-clipboard-text="{% include 'event.md' %}">
                    Copy Event
                </button>
                <button class="btn btn-outline-info btn-sm my-2 copy-button"
                        data-placement="bottom"
                        data-clipboard-action="copy"
                        data-clipboard-text="{% include 'full-names.md' %}">
                    Copy Full Names
                </button>
                <span class="badge badge-success badge-pill">{{count}}</span>
            </li>
        {% endif %}
    </ul>
    <hr/>
    {% include "zulip-comments.html" %}
    {% if current_user.is_admin or event.created_by and event.created_by.fetch().email == current_user.email %}
    <div class="form-group row">
        <div class="col-sm-10">
            <textarea class="form-control" id="event-description" name="event-description" rows="2">{{ event.description or '' }}</textarea>
        </div>
    </div>
    <button type="submit" onclick='update_description("{{ event.id }}")'
            class="btn btn-primary">
        Update
    </button>
    <hr/>
    {% endif %}
{% endblock %}
